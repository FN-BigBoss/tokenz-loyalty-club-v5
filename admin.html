
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TokenZ Loyalty Club - Admin Dashboard v5.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .section-content { display: none; }
        .section-content.active { display: block; }
        .nav-item.active { background-color: #3B82F6; color: white; }
        .rating-stars { color: #FCD34D; }
        .featured-badge { 
            background: linear-gradient(45deg, #8B5CF6, #EC4899);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .follow-button:hover { transform: translateY(-1px); }
        .notification-toast {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-2xl font-bold text-gray-900">TokenZ Admin v5.1</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-600">
                        <span id="current-time"></span>
                    </div>
                    <button onclick="exportData()" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-download"></i>
                    </button>
                    <button onclick="showImportModal()" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-upload"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex gap-8">
            <!-- Sidebar Navigation -->
            <div class="w-64 flex-shrink-0">
                <nav class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                    <ul class="space-y-2">
                        <li>
                            <button onclick="showSection('dashboard')" class="nav-item w-full text-left px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors active">
                                <i class="fas fa-tachometer-alt mr-3"></i>Dashboard
                            </button>
                        </li>
                        <li>
                            <button onclick="showSection('merchants')" class="nav-item w-full text-left px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors">
                                <i class="fas fa-store mr-3"></i>Merchants
                            </button>
                        </li>
                        <li>
                            <button onclick="showSection('products')" class="nav-item w-full text-left px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors">
                                <i class="fas fa-box mr-3"></i>Products
                            </button>
                        </li>
                        <li>
                            <button onclick="showSection('users')" class="nav-item w-full text-left px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors">
                                <i class="fas fa-users mr-3"></i>Users
                            </button>
                        </li>
                        <li>
                            <button onclick="showSection('ratings')" class="nav-item w-full text-left px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors">
                                <i class="fas fa-star mr-3"></i>Ratings & Reviews
                            </button>
                        </li>
                        <li>
                            <button onclick="showSection('featured')" class="nav-item w-full text-left px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors">
                                <i class="fas fa-crown mr-3"></i>Featured Products
                            </button>
                        </li>
                        <li>
                            <button onclick="showSection('analytics')" class="nav-item w-full text-left px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors">
                                <i class="fas fa-chart-bar mr-3"></i>Analytics
                            </button>
                        </li>
                    </ul>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="flex-1">
                <!-- Dashboard Section -->
                <div id="dashboard-section" class="section-content active">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <!-- Stats Cards -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center">
                                <div class="p-2 bg-blue-100 rounded-lg">
                                    <i class="fas fa-store text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Total Merchants</p>
                                    <p class="text-2xl font-semibold text-gray-900" id="total-merchants">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center">
                                <div class="p-2 bg-green-100 rounded-lg">
                                    <i class="fas fa-box text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Total Products</p>
                                    <p class="text-2xl font-semibold text-gray-900" id="total-products">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center">
                                <div class="p-2 bg-purple-100 rounded-lg">
                                    <i class="fas fa-users text-purple-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Total Users</p>
                                    <p class="text-2xl font-semibold text-gray-900" id="total-users">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center">
                                <div class="p-2 bg-yellow-100 rounded-lg">
                                    <i class="fas fa-star text-yellow-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Total Ratings</p>
                                    <p class="text-2xl font-semibold text-gray-900" id="total-ratings">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200">
                            <h2 class="text-xl font-semibold text-gray-900">Recent Activity</h2>
                        </div>
                        <div class="p-6">
                            <div id="recent-activity" class="space-y-4">
                                <p class="text-gray-500 text-center py-8">No recent activity</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Merchants Section -->
                <div id="merchants-section" class="section-content">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex justify-between items-center">
                                <h2 class="text-xl font-semibold text-gray-900">Merchants Management</h2>
                                <button onclick="showAddMerchantModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                                    <i class="fas fa-plus mr-2"></i>Add Merchant
                                </button>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="mb-4">
                                <input type="text" id="merchant-search" placeholder="Search merchants..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div id="merchants-list" class="space-y-4">
                                <p class="text-gray-500 text-center py-8">No merchants found</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products Section -->
                <div id="products-section" class="section-content">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex justify-between items-center">
                                <h2 class="text-xl font-semibold text-gray-900">Products Management</h2>
                                <div class="flex space-x-3">
                                    <button onclick="showFeaturedProductsModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
                                        <i class="fas fa-star mr-2"></i>Manage Featured
                                    </button>
                                    <button onclick="showAddProductModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                                        <i class="fas fa-plus mr-2"></i>Add Product
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="mb-4 flex space-x-4">
                                <input type="text" id="product-search" placeholder="Search products..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <select id="product-filter-merchant" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">All Merchants</option>
                                </select>
                                <select id="product-filter-status" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                            </div>
                            <div id="products-list" class="space-y-4">
                                <p class="text-gray-500 text-center py-8">No products found</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Users Section -->
                <div id="users-section" class="section-content">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex justify-between items-center">
                                <h2 class="text-xl font-semibold text-gray-900">Users Management</h2>
                                <button onclick="showAddUserModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                                    <i class="fas fa-plus mr-2"></i>Add User
                                </button>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="mb-4">
                                <input type="text" id="user-search" placeholder="Search users..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div id="users-list" class="space-y-4">
                                <p class="text-gray-500 text-center py-8">No users found</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NEW: Ratings & Reviews Section -->
                <div id="ratings-section" class="section-content">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex justify-between items-center">
                                <h2 class="text-xl font-semibold text-gray-900">Ratings & Reviews Management</h2>
                                <div class="flex space-x-3">
                                    <select id="rating-filter-status" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="">All Status</option>
                                        <option value="active">Active</option>
                                        <option value="hidden">Hidden</option>
                                        <option value="flagged">Flagged</option>
                                    </select>
                                    <select id="rating-filter-rating" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="">All Ratings</option>
                                        <option value="5">5 Stars</option>
                                        <option value="4">4 Stars</option>
                                        <option value="3">3 Stars</option>
                                        <option value="2">2 Stars</option>
                                        <option value="1">1 Star</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="mb-6">
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                        <div class="text-2xl font-bold text-green-600" id="ratings-total">0</div>
                                        <div class="text-sm text-green-600">Total Reviews</div>
                                    </div>
                                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                        <div class="text-2xl font-bold text-yellow-600" id="ratings-average">0.0</div>
                                        <div class="text-sm text-yellow-600">Average Rating</div>
                                    </div>
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                        <div class="text-2xl font-bold text-blue-600" id="ratings-this-month">0</div>
                                        <div class="text-sm text-blue-600">This Month</div>
                                    </div>
                                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                        <div class="text-2xl font-bold text-red-600" id="ratings-flagged">0</div>
                                        <div class="text-sm text-red-600">Flagged</div>
                                    </div>
                                </div>
                            </div>
                            <div id="ratings-list" class="space-y-4">
                                <p class="text-gray-500 text-center py-8">No ratings found</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NEW: Featured Products Section -->
                <div id="featured-section" class="section-content">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex justify-between items-center">
                                <h2 class="text-xl font-semibold text-gray-900">Featured Products Management</h2>
                                <button onclick="showAddFeaturedModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
                                    <i class="fas fa-star mr-2"></i>Add Featured Product
                                </button>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="mb-6">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                        <div class="text-2xl font-bold text-purple-600" id="featured-active">0</div>
                                        <div class="text-sm text-purple-600">Active Featured</div>
                                    </div>
                                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                                        <div class="text-2xl font-bold text-orange-600" id="featured-expiring">0</div>
                                        <div class="text-sm text-orange-600">Expiring Soon</div>
                                    </div>
                                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                        <div class="text-2xl font-bold text-gray-600" id="featured-expired">0</div>
                                        <div class="text-sm text-gray-600">Expired</div>
                                    </div>
                                </div>
                            </div>
                            <div id="featured-list" class="space-y-4">
                                <p class="text-gray-500 text-center py-8">No featured products</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NEW: Analytics Section -->
                <div id="analytics-section" class="section-content">
                    <div class="space-y-6">
                        <!-- Overview Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-600">Total Revenue</p>
                                        <p class="text-2xl font-semibold text-gray-900" id="analytics-revenue">R0.00</p>
                                    </div>
                                    <div class="p-2 bg-green-100 rounded-lg">
                                        <i class="fas fa-dollar-sign text-green-600"></i>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <span class="text-sm text-green-600" id="revenue-growth">+0%</span>
                                    <span class="text-sm text-gray-500">vs last month</span>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-600">Active Users</p>
                                        <p class="text-2xl font-semibold text-gray-900" id="analytics-active-users">0</p>
                                    </div>
                                    <div class="p-2 bg-blue-100 rounded-lg">
                                        <i class="fas fa-users text-blue-600"></i>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <span class="text-sm text-blue-600" id="users-growth">+0%</span>
                                    <span class="text-sm text-gray-500">vs last month</span>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-600">Avg Rating</p>
                                        <p class="text-2xl font-semibold text-gray-900" id="analytics-avg-rating">0.0</p>
                                    </div>
                                    <div class="p-2 bg-yellow-100 rounded-lg">
                                        <i class="fas fa-star text-yellow-600"></i>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <span class="text-sm text-yellow-600" id="rating-trend">+0.0</span>
                                    <span class="text-sm text-gray-500">vs last month</span>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-600">Total Follows</p>
                                        <p class="text-2xl font-semibold text-gray-900" id="analytics-follows">0</p>
                                    </div>
                                    <div class="p-2 bg-purple-100 rounded-lg">
                                        <i class="fas fa-heart text-purple-600"></i>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <span class="text-sm text-purple-600" id="follows-growth">+0%</span>
                                    <span class="text-sm text-gray-500">vs last month</span>
                                </div>
                            </div>
                        </div>

                        <!-- Top Performers -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                                <div class="p-6 border-b border-gray-200">
                                    <h3 class="text-lg font-semibold text-gray-900">Top Rated Products</h3>
                                </div>
                                <div class="p-6">
                                    <div id="top-products" class="space-y-4">
                                        <p class="text-gray-500 text-center py-4">No data available</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                                <div class="p-6 border-b border-gray-200">
                                    <h3 class="text-lg font-semibold text-gray-900">Most Followed Merchants</h3>
                                </div>
                                <div class="p-6">
                                    <div id="top-merchants" class="space-y-4">
                                        <p class="text-gray-500 text-center py-4">No data available</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals will be added here -->
    <div id="modal-container"></div>

    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>
        // Initialize admin data with v5.1 structure
        let adminData = {
            merchants: [],
            products: [],
            users: [],
            ratings: [], // New in v5.1
            categories: {
                merchant: [
                    "Food & Beverage", "Fitness & Health", "Home & Utilities", "Transportation",
                    "Entertainment & Media", "Personal Care & Beauty", "Professional Services",
                    "Technology & Software", "Education & Learning", "Financial Services",
                    "Retail & Shopping", "Travel & Hospitality", "Security & Safety", "Pet Care",
                    "Automotive", "Real Estate", "Insurance", "Telecommunications",
                    "Energy & Environment", "Other"
                ],
                product: [
                    "Coffee & Tea", "Food & Meals", "Beverages", "Snacks & Treats",
                    "Gym Memberships", "Personal Training", "Wellness Services", "Beauty Treatments",
                    "Streaming Services", "Gaming Subscriptions", "Music & Audio", "Books & Magazines",
                    "Software Subscriptions", "Cloud Storage", "VPN Services", "Productivity Tools",
                    "Home Security", "Utilities", "Internet & Phone", "Transportation Passes",
                    "Car Services", "Insurance Plans", "Financial Services", "Educational Courses",
                    "Professional Development", "Pet Supplies", "Pet Services", "Clothing & Accessories",
                    "Home Goods", "Electronics", "Other"
                ]
            },
            recentActivity: [],
            systemSettings: {
                currency: 'ZAR',
                systemName: 'TokenZ Loyalty Club',
                adminEmail: 'admin@tokenzclub.com',
                featuredProductDuration: 30, // days
                maxRatingValue: 5,
                allowAnonymousRatings: false
            }
        };

        // Load data from localStorage
        function loadData() {
            try {
                const stored = localStorage.getItem('tlc_admin_data');
                if (stored) {
                    const parsedData = JSON.parse(stored);
                    
                    // Migrate data to v5.1 if needed using AdminUtilities
                    if (typeof AdminUtilities !== 'undefined') {
                        adminData = AdminUtilities.migrateDataToV51(parsedData);
                    } else {
                        // Basic migration if utilities not loaded
                        adminData = { ...adminData, ...parsedData };
                        if (!adminData.ratings) adminData.ratings = [];
                    }
                    
                    console.log('✅ Data loaded and migrated to v5.1');
                } else {
                    console.log('📝 Using default data structure');
                }
            } catch (error) {
                console.error('❌ Error loading data:', error);
                showNotification('Error loading data. Using defaults.', 'error');
            }
        }

        // Save data to localStorage
        function saveData() {
            try {
                localStorage.setItem('tlc_admin_data', JSON.stringify(adminData));
                console.log('💾 Data saved successfully');
            } catch (error) {
                console.error('❌ Error saving data:', error);
                showNotification('Error saving data!', 'error');
            }
        }

        // Navigation functions
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section-content').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName + '-section').classList.add('active');
            
            // Add active class to clicked nav item
            event.target.classList.add('active');
            
            // Load section-specific data
            switch(sectionName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'merchants':
                    loadMerchants();
                    break;
                case 'products':
                    loadProducts();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'ratings':
                    loadRatings();
                    break;
                case 'featured':
                    loadFeaturedProducts();
                    break;
                case 'analytics':
                    loadAnalytics();
                    break;
            }
        }

        // Dashboard functions
        function loadDashboard() {
            // Update stats
            document.getElementById('total-merchants').textContent = adminData.merchants.length;
            document.getElementById('total-products').textContent = adminData.products.length;
            document.getElementById('total-users').textContent = adminData.users.length;
            document.getElementById('total-ratings').textContent = adminData.ratings ? adminData.ratings.length : 0;
            
            // Load recent activity
            loadRecentActivity();
        }

        function loadRecentActivity() {
            const container = document.getElementById('recent-activity');
            const activities = adminData.recentActivity || [];
            
            if (activities.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No recent activity</p>';
                return;
            }
            
            container.innerHTML = activities.slice(0, 10).map(activity => `
                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                    <div class="flex-shrink-0">
                        <i class="fas fa-${getActivityIcon(activity.type)} text-gray-600"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm text-gray-900">${activity.description}</p>
                        <p class="text-xs text-gray-500">${formatDateTime(activity.timestamp)}</p>
                    </div>
                </div>
            `).join('');
        }

        function getActivityIcon(type) {
            const icons = {
                merchant: 'store',
                product: 'box',
                user: 'user',
                rating: 'star',
                system: 'cog'
            };
            return icons[type] || 'info-circle';
        }

        // NEW: Ratings Management Functions
        function loadRatings() {
            const ratings = adminData.ratings || [];
            
            // Update stats
            document.getElementById('ratings-total').textContent = ratings.length;
            
            const activeRatings = ratings.filter(r => r.status === 'active');
            const averageRating = activeRatings.length > 0 ? 
                (activeRatings.reduce((sum, r) => sum + r.rating, 0) / activeRatings.length).toFixed(1) : '0.0';
            document.getElementById('ratings-average').textContent = averageRating;
            
            const thisMonth = new Date();
            thisMonth.setDate(1);
            const thisMonthRatings = ratings.filter(r => new Date(r.date) >= thisMonth);
            document.getElementById('ratings-this-month').textContent = thisMonthRatings.length;
            
            const flaggedRatings = ratings.filter(r => r.status === 'flagged');
            document.getElementById('ratings-flagged').textContent = flaggedRatings.length;
            
            // Load ratings list
            displayRatings(ratings);
        }

        function displayRatings(ratings) {
            const container = document.getElementById('ratings-list');
            
            if (ratings.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No ratings found</p>';
                return;
            }
            
            container.innerHTML = ratings.map(rating => {
                const user = adminData.users.find(u => u.id === rating.userId);
                const product = adminData.products.find(p => p.id === rating.productId);
                const merchant = adminData.merchants.find(m => m.id === rating.merchantId);
                
                return `
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <div class="rating-stars text-yellow-400">
                                        ${'★'.repeat(rating.rating)}${'☆'.repeat(5 - rating.rating)}
                                    </div>
                                    <span class="text-sm text-gray-600">${rating.rating}/5</span>
                                    <span class="px-2 py-1 text-xs rounded-full ${getRatingStatusColor(rating.status)}">
                                        ${rating.status}
                                    </span>
                                </div>
                                <p class="text-sm text-gray-900 mb-2">
                                    <strong>${user ? user.name : 'Unknown User'}</strong> rated 
                                    <strong>${product ? product.name : 'Unknown Product'}</strong>
                                    ${merchant ? `at ${merchant.name}` : ''}
                                </p>
                                ${rating.review ? `<p class="text-sm text-gray-700 mb-2">"${rating.review}"</p>` : ''}
                                <p class="text-xs text-gray-500">${formatDateTime(rating.date)}</p>
                            </div>
                            <div class="flex space-x-2 ml-4">
                                ${rating.status === 'active' ? `
                                    <button onclick="moderateRating('${rating.id}', 'hidden')" class="text-yellow-600 hover:text-yellow-800">
                                        <i class="fas fa-eye-slash"></i>
                                    </button>
                                    <button onclick="moderateRating('${rating.id}', 'flagged')" class="text-red-600 hover:text-red-800">
                                        <i class="fas fa-flag"></i>
                                    </button>
                                ` : ''}
                                ${rating.status === 'hidden' || rating.status === 'flagged' ? `
                                    <button onclick="moderateRating('${rating.id}', 'active')" class="text-green-600 hover:text-green-800">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                ` : ''}
                                <button onclick="deleteRating('${rating.id}')" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getRatingStatusColor(status) {
            const colors = {
                active: 'bg-green-100 text-green-800',
                hidden: 'bg-yellow-100 text-yellow-800',
                flagged: 'bg-red-100 text-red-800'
            };
            return colors[status] || 'bg-gray-100 text-gray-800';
        }

        function moderateRating(ratingId, newStatus) {
            if (typeof AdminUtilities !== 'undefined') {
                AdminUtilities.moderateRating(adminData, ratingId, newStatus);
            } else {
                // Fallback moderation
                const rating = adminData.ratings.find(r => r.id === ratingId);
                if (rating) {
                    rating.status = newStatus;
                }
            }
            
            saveData();
            loadRatings();
            showNotification(`Rating ${newStatus}`, 'success');
        }

        function deleteRating(ratingId) {
            if (confirm('Are you sure you want to delete this rating?')) {
                if (typeof AdminUtilities !== 'undefined') {
                    AdminUtilities.deleteRating(adminData, ratingId);
                } else {
                    // Fallback deletion
                    const index = adminData.ratings.findIndex(r => r.id === ratingId);
                    if (index >= 0) {
                        adminData.ratings.splice(index, 1);
                    }
                }
                
                saveData();
                loadRatings();
                showNotification('Rating deleted', 'success');
            }
        }

        // NEW: Featured Products Management Functions
        function loadFeaturedProducts() {
            // Clean up expired featured products first
            if (typeof AdminUtilities !== 'undefined') {
                AdminUtilities.checkExpiredFeaturedProducts(adminData);
            }
            
            const featuredProducts = adminData.products.filter(p => p.featured);
            const activeFeatured = featuredProducts.filter(p => !isFeaturedExpired(p));
            const expiringSoon = activeFeatured.filter(p => getDaysUntilExpiry(p.featuredExpiry) <= 7);
            const expired = featuredProducts.filter(p => isFeaturedExpired(p));
            
            // Update stats
            document.getElementById('featured-active').textContent = activeFeatured.length;
            document.getElementById('featured-expiring').textContent = expiringSoon.length;
            document.getElementById('featured-expired').textContent = expired.length;
            
            // Display featured products
            displayFeaturedProducts(featuredProducts);
        }

        function displayFeaturedProducts(products) {
            const container = document.getElementById('featured-list');
            
            if (products.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No featured products</p>';
                return;
            }
            
            container.innerHTML = products.map(product => {
                const merchant = adminData.merchants.find(m => m.id === product.merchantId);
                const isExpired = isFeaturedExpired(product);
                const daysLeft = getDaysUntilExpiry(product.featuredExpiry);
                
                return `
                    <div class="border border-gray-200 rounded-lg p-4 ${isExpired ? 'bg-red-50' : ''}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <h3 class="font-semibold text-gray-900">${product.name}</h3>
                                    ${product.featured && !isExpired ? '<span class="featured-badge text-white text-xs px-2 py-1 rounded-full">FEATURED</span>' : ''}
                                    ${isExpired ? '<span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full">EXPIRED</span>' : ''}
                                </div>
                                <p class="text-sm text-gray-600 mb-2">${merchant ? merchant.name : 'Unknown Merchant'}</p>
                                <p class="text-sm text-gray-700 mb-2">${product.shortDescription}</p>
                                <div class="flex items-center space-x-4 text-sm text-gray-500">
                                    <span>Price: R${product.price}</span>
                                    ${product.featuredExpiry ? `
                                        <span class="${isExpired ? 'text-red-600' : daysLeft <= 7 ? 'text-orange-600' : 'text-green-600'}">
                                            ${isExpired ? 'Expired' : `${daysLeft} days left`}
                                        </span>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="flex space-x-2 ml-4">
                                ${product.featured ? `
                                    <button onclick="removeFeatured('${product.id}')" class="text-red-600 hover:text-red-800">
                                        <i class="fas fa-star-half-alt"></i>
                                    </button>
                                ` : `
                                    <button onclick="makeFeatured('${product.id}')" class="text-purple-600 hover:text-purple-800">
                                        <i class="fas fa-star"></i>
                                    </button>
                                `}
                                ${product.featured && !isExpired ? `
                                    <button onclick="extendFeatured('${product.id}')" class="text-blue-600 hover:text-blue-800">
                                        <i class="fas fa-clock"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function makeFeatured(productId) {
            const days = prompt('How many days should this product be featured?', '30');
            if (days && !isNaN(days) && parseInt(days) > 0) {
                if (typeof AdminUtilities !== 'undefined') {
                    AdminUtilities.setProductFeatured(adminData, productId, true, parseInt(days));
                } else {
                    // Fallback
                    const product = adminData.products.find(p => p.id === productId);
                    if (product) {
                        product.featured = true;
                        const expiry = new Date();
                        expiry.setDate(expiry.getDate() + parseInt(days));
                        product.featuredExpiry = expiry.toISOString();
                    }
                }
                
                saveData();
                loadFeaturedProducts();
                showNotification('Product featured successfully', 'success');
            }
        }

        function removeFeatured(productId) {
            if (confirm('Remove this product from featured list?')) {
                if (typeof AdminUtilities !== 'undefined') {
                    AdminUtilities.setProductFeatured(adminData, productId, false);
                } else {
                    // Fallback
                    const product = adminData.products.find(p => p.id === productId);
                    if (product) {
                        product.featured = false;
                        product.featuredExpiry = null;
                    }
                }
                
                saveData();
                loadFeaturedProducts();
                showNotification('Product removed from featured', 'success');
            }
        }

        function extendFeatured(productId) {
            const days = prompt('Extend featured period by how many days?', '30');
            if (days && !isNaN(days) && parseInt(days) > 0) {
                const product = adminData.products.find(p => p.id === productId);
                if (product && product.featuredExpiry) {
                    const currentExpiry = new Date(product.featuredExpiry);
                    currentExpiry.setDate(currentExpiry.getDate() + parseInt(days));
                    product.featuredExpiry = currentExpiry.toISOString();
                    
                    saveData();
                    loadFeaturedProducts();
                    showNotification('Featured period extended', 'success');
                }
            }
        }

        // NEW: Analytics Functions
        function loadAnalytics() {
            calculateAnalytics();
        }

        function calculateAnalytics() {
            const products = adminData.products || [];
            const users = adminData.users || [];
            const ratings = adminData.ratings || [];
            const merchants = adminData.merchants || [];
            
            // Calculate total revenue (mock calculation)
            const totalRevenue = products.reduce((sum, product) => sum + (product.price * (product.salesCount || 0)), 0);
            document.getElementById('analytics-revenue').textContent = `R${totalRevenue.toFixed(2)}`;
            
            // Active users
            const activeUsers = users.filter(u => u.status === 'active').length;
            document.getElementById('analytics-active-users').textContent = activeUsers;
            
            // Average rating
            const activeRatings = ratings.filter(r => r.status === 'active');
            const avgRating = activeRatings.length > 0 ? 
                (activeRatings.reduce((sum, r) => sum + r.rating, 0) / activeRatings.length).toFixed(1) : '0.0';
            document.getElementById('analytics-avg-rating').textContent = avgRating;
            
            // Total follows (mock calculation)
            const totalFollows = merchants.reduce((sum, merchant) => sum + (merchant.followerCount || 0), 0);
            document.getElementById('analytics-follows').textContent = totalFollows;
            
            // Load top performers
            loadTopProducts();
            loadTopMerchants();
        }

        function loadTopProducts() {
            const products = adminData.products || [];
            const topProducts = products
                .filter(p => p.averageRating > 0)
                .sort((a, b) => (b.averageRating || 0) - (a.averageRating || 0))
                .slice(0, 5);
            
            const container = document.getElementById('top-products');
            
            if (topProducts.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No rated products yet</p>';
                return;
            }
            
            container.innerHTML = topProducts.map((product, index) => {
                const merchant = adminData.merchants.find(m => m.id === product.merchantId);
                return `
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                            <span class="text-sm font-semibold text-blue-600">${index + 1}</span>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-900">${product.name}</p>
                            <p class="text-xs text-gray-500">${merchant ? merchant.name : 'Unknown'}</p>
                        </div>
                        <div class="text-right">
                            <div class="rating-stars text-yellow-400 text-sm">
                                ${'★'.repeat(Math.floor(product.averageRating || 0))}
                            </div>
                            <p class="text-xs text-gray-500">${(product.averageRating || 0).toFixed(1)}/5</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadTopMerchants() {
            const merchants = adminData.merchants || [];
            const topMerchants = merchants
                .sort((a, b) => (b.followerCount || 0) - (a.followerCount || 0))
                .slice(0, 5);
            
            const container = document.getElementById('top-merchants');
            
            if (topMerchants.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No merchants with followers yet</p>';
                return;
            }
            
            container.innerHTML = topMerchants.map((merchant, index) => `
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0 w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                        <span class="text-sm font-semibold text-purple-600">${index + 1}</span>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">${merchant.name}</p>
                        <p class="text-xs text-gray-500">${merchant.category || 'Uncategorized'}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-semibold text-gray-900">${merchant.followerCount || 0}</p>
                        <p class="text-xs text-gray-500">followers</p>
                    </div>
                </div>
            `).join('');
        }

        // Utility functions
        function isFeaturedExpired(product) {
            if (!product.featured || !product.featuredExpiry) return true;
            return new Date(product.featuredExpiry) < new Date();
        }

        function getDaysUntilExpiry(dateString) {
            if (!dateString) return 0;
            const expiry = new Date(dateString);
            const now = new Date();
            const diffTime = expiry - now;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleString();
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification-toast bg-white border-l-4 ${getNotificationColor(type)} rounded-lg shadow-lg p-4 max-w-sm`;
            
            notification.innerHTML = `
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i class="fas fa-${getNotificationIcon(type)} ${getNotificationTextColor(type)}"></i>
                    </div>
                    <div class="ml-3 flex-1">
                        <p class="text-sm text-gray-800">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function getNotificationColor(type) {
            const colors = {
                success: 'border-green-500',
                error: 'border-red-500',
                warning: 'border-yellow-500',
                info: 'border-blue-500'
            };
            return colors[type] || colors.info;
        }

        function getNotificationTextColor(type) {
            const colors = {
                success: 'text-green-500',
                error: 'text-red-500',
                warning: 'text-yellow-500',
                info: 'text-blue-500'
            };
            return colors[type] || colors.info;
        }

        function getNotificationIcon(type) {
            const icons = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            return icons[type] || icons.info;
        }

        // Placeholder functions for existing functionality
        function loadMerchants() {
            // Existing merchant loading logic
            console.log('Loading merchants...');
        }

        function loadProducts() {
            // Existing product loading logic
            console.log('Loading products...');
        }

        function loadUsers() {
            // Existing user loading logic
            console.log('Loading users...');
        }

        function showAddMerchantModal() {
            console.log('Show add merchant modal');
        }

        function showAddProductModal() {
            console.log('Show add product modal');
        }

        function showAddUserModal() {
            console.log('Show add user modal');
        }

        function showAddFeaturedModal() {
            console.log('Show add featured modal');
        }

        function exportData() {
            console.log('Export data');
        }

        function showImportModal() {
            console.log('Show import modal');
        }

        // Update current time
        function updateCurrentTime() {
            document.getElementById('current-time').textContent = new Date().toLocaleString();
        }

        // Initialize the application
        function init() {
            console.log('🚀 Initializing TokenZ Admin v5.1...');
            
            // Load data
            loadData();
            
            // Load dashboard by default
            loadDashboard();
            
            // Update time every minute
            updateCurrentTime();
            setInterval(updateCurrentTime, 60000);
            
            // Set up search filters
            setupSearchFilters();
            
            console.log('✅ TokenZ Admin v5.1 initialized successfully');
        }

        function setupSearchFilters() {
            // Rating filters
            document.getElementById('rating-filter-status')?.addEventListener('change', function() {
                filterRatings();
            });
            
            document.getElementById('rating-filter-rating')?.addEventListener('change', function() {
                filterRatings();
            });
        }

        function filterRatings() {
            const statusFilter = document.getElementById('rating-filter-status').value;
            const ratingFilter = document.getElementById('rating-filter-rating').value;
            
            let filteredRatings = adminData.ratings || [];
            
            if (statusFilter) {
                filteredRatings = filteredRatings.filter(r => r.status === statusFilter);
            }
            
            if (ratingFilter) {
                filteredRatings = filteredRatings.filter(r => r.rating === parseInt(ratingFilter));
            }
            
            displayRatings(filteredRatings);
        }

        // Start the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'95e419aa050373b6',t:'MTc1MjM2MDYzNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
